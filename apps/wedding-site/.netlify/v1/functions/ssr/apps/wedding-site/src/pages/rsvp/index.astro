---
/**
 * RSVP page - accessed via tokenized link
 * Route: /rsvp?token=...
 *
 * PRD requirements:
 * - Guest can view RSVP form via tokenized link
 * - RSVP form loads with guest name prefilled
 * - Mobile-first with large tap targets
 */
import { fetchRsvpView } from '../../lib/api';
import type { Theme } from '../../types';

// Get token from query string
const token = Astro.url.searchParams.get('token');

// Redirect to home if no token
if (!token) {
  return Astro.redirect('/');
}

// Fetch RSVP data
const { data, error } = await fetchRsvpView(token);

// Handle errors
let errorMessage = '';
if (error === 'INVALID_TOKEN') {
  errorMessage = 'This RSVP link is no longer valid. Please contact the couple for a new invitation.';
} else if (error === 'FEATURE_DISABLED') {
  errorMessage = 'RSVPs are currently closed for this event.';
} else if (error === 'WEDDING_NOT_FOUND') {
  errorMessage = 'This wedding event could not be found.';
} else if (error) {
  errorMessage = 'Something went wrong. Please try again later.';
}

// Default theme for error pages
const defaultTheme: Theme = {
  primary: '#c9826b',
  accent: '#8fac8b',
  neutralLight: '#faf8f5',
  neutralDark: '#2d2d2d',
};

const theme = data?.theme || defaultTheme;
const guest = data?.guest;
const wedding = data?.wedding;
const title = wedding
  ? `RSVP - ${wedding.partnerNames[0]} & ${wedding.partnerNames[1]}`
  : 'RSVP';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="RSVP to our wedding celebration" />
    <title>{title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
    <style define:vars={{
      primary: theme.primary,
      accent: theme.accent,
      neutralLight: theme.neutralLight,
      neutralDark: theme.neutralDark,
    }}>
      :root {
        --primary: var(--primary);
        --accent: var(--accent);
        --neutral-light: var(--neutralLight);
        --neutral-dark: var(--neutralDark);
        --neutral-surface: color-mix(in srgb, var(--neutral-light) 92%, var(--neutral-dark));
        --neutral-border: color-mix(in srgb, var(--neutral-dark) 12%, var(--neutral-light));
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', 'Helvetica Neue', sans-serif;
        background-color: var(--neutral-light);
        color: var(--neutral-dark);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
      }

      .rsvp-container {
        width: 100%;
        max-width: 480px;
        background: var(--neutral-surface);
        border-radius: 12px;
        padding: 2.5rem 2rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
      }

      .couple-names {
        font-family: 'Cormorant Garamond', Georgia, serif;
        font-size: 1.75rem;
        font-weight: 500;
        text-align: center;
        color: var(--primary);
        margin: 0 0 0.5rem;
      }

      .event-label {
        text-align: center;
        font-size: 0.875rem;
        color: var(--neutral-dark);
        opacity: 0.7;
        margin-bottom: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .greeting {
        font-family: 'Cormorant Garamond', Georgia, serif;
        font-size: 1.5rem;
        text-align: center;
        margin-bottom: 2rem;
        color: var(--neutral-dark);
      }

      .greeting strong {
        color: var(--primary);
      }

      .question {
        font-size: 1.125rem;
        text-align: center;
        margin-bottom: 1.5rem;
        font-weight: 500;
      }

      .rsvp-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .rsvp-option {
        display: flex;
        align-items: center;
        padding: 1.25rem;
        border: 2px solid var(--neutral-border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        width: 100%;
        text-align: left;
        font-size: 1rem;
      }

      .rsvp-option:hover {
        border-color: var(--primary);
      }

      .rsvp-option:focus-within {
        border-color: var(--primary);
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .rsvp-option.selected {
        border-color: var(--primary);
        background-color: rgba(201, 130, 107, 0.08);
      }

      .rsvp-option input {
        position: absolute;
        opacity: 0;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }

      .rsvp-option-radio {
        width: 24px;
        height: 24px;
        border: 2px solid var(--neutral-border);
        border-radius: 50%;
        margin-right: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
      }

      .rsvp-option.selected .rsvp-option-radio {
        border-color: var(--primary);
        background-color: var(--primary);
      }

      .rsvp-option.selected .rsvp-option-radio::after {
        content: '';
        width: 8px;
        height: 8px;
        background: var(--neutral-light);
        border-radius: 50%;
      }

      .party-size-section {
        margin-bottom: 2rem;
        display: none;
      }

      .party-size-section.visible {
        display: block;
      }

      .section-label {
        font-size: 0.875rem;
        color: var(--neutral-dark);
        opacity: 0.7;
        margin-bottom: 0.75rem;
        display: block;
      }

      .stepper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
      }

      .stepper-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid var(--primary);
        background: transparent;
        color: var(--primary);
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .stepper-btn:hover:not(:disabled) {
        background: var(--primary);
        color: var(--neutral-light);
      }

      .stepper-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .stepper-btn:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .stepper-value {
        font-size: 2rem;
        font-weight: 600;
        min-width: 60px;
        text-align: center;
      }

      .dietary-section {
        margin-bottom: 2rem;
        display: none;
      }

      .dietary-section.visible {
        display: block;
      }

      .dietary-input {
        width: 100%;
        padding: 1rem;
        border: 2px solid var(--neutral-border);
        border-radius: 8px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        min-height: 100px;
      }

      .dietary-input:focus {
        outline: none;
        border-color: var(--primary);
      }

      /* Plus-one section styles */
      .plus-one-section {
        margin-bottom: 2rem;
        display: none;
      }

      .plus-one-section.visible {
        display: block;
      }

      .plus-one-intro {
        font-size: 0.95rem;
        color: var(--neutral-dark);
        opacity: 0.8;
        margin-bottom: 1rem;
        line-height: 1.5;
      }

      .plus-one-cards {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .plus-one-card {
        background: var(--neutral-light);
        border: 1px solid var(--neutral-border);
        border-radius: 8px;
        padding: 1rem;
      }

      .plus-one-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .plus-one-card-label {
        font-weight: 500;
        font-size: 0.95rem;
        color: var(--primary);
      }

      .plus-one-remove-btn {
        background: none;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        color: var(--neutral-dark);
        opacity: 0.5;
        padding: 0.25rem;
        line-height: 1;
      }

      .plus-one-remove-btn:hover {
        opacity: 1;
        color: var(--primary);
      }

      .plus-one-remove-btn:focus-visible {
        opacity: 1;
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .plus-one-input {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--neutral-border);
        border-radius: 6px;
        font-size: 1rem;
        font-family: inherit;
        margin-bottom: 0.75rem;
      }

      .plus-one-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(201, 130, 107, 0.2);
      }

      .plus-one-input:last-child {
        margin-bottom: 0;
      }

      .plus-one-dietary {
        font-size: 0.95rem;
      }

      .add-plus-one-btn {
        width: 100%;
        padding: 0.875rem;
        background: transparent;
        color: var(--primary);
        border: 2px dashed var(--primary);
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 0.5rem;
      }

      .add-plus-one-btn:hover:not(:disabled) {
        background: rgba(201, 130, 107, 0.08);
      }

      .add-plus-one-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .add-plus-one-btn:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .plus-one-limit-hint {
        font-size: 0.8rem;
        color: var(--neutral-dark);
        opacity: 0.6;
        text-align: center;
        margin-top: 0.5rem;
      }

      .submit-btn {
        width: 100%;
        padding: 1.25rem;
        background: var(--primary);
        color: var(--neutral-light);
        border: none;
        border-radius: 8px;
        font-size: 1.125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .submit-btn:hover:not(:disabled) {
        opacity: 0.9;
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .submit-btn:focus-visible {
        outline: 2px solid var(--neutral-dark);
        outline-offset: 2px;
      }

      .error-container {
        text-align: center;
        padding: 2rem;
      }

      .error-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      .error-message {
        font-size: 1.125rem;
        color: var(--neutral-dark);
        opacity: 0.8;
        line-height: 1.6;
      }

      .success-container {
        text-align: center;
        display: none;
      }

      .success-container.visible {
        display: block;
      }

      .success-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
      }

      .success-title {
        font-family: 'Cormorant Garamond', Georgia, serif;
        font-size: 1.75rem;
        color: var(--primary);
        margin-bottom: 1rem;
      }

      .success-message {
        font-size: 1.125rem;
        line-height: 1.6;
        color: var(--neutral-dark);
        opacity: 0.8;
      }

      .form-container {
        display: block;
      }

      .form-container.hidden {
        display: none;
      }

      .current-status {
        background: rgba(143, 172, 139, 0.15);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 0.875rem;
      }

      .current-status strong {
        color: var(--accent);
      }

      .back-link {
        display: block;
        text-align: center;
        margin-top: 1.5rem;
        color: var(--primary);
        text-decoration: none;
        font-size: 0.875rem;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      /* Privacy/data section */
      .privacy-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--neutral-border);
      }

      .privacy-link {
        display: block;
        text-align: center;
        color: var(--neutral-dark);
        opacity: 0.6;
        text-decoration: none;
        font-size: 0.8rem;
        transition: opacity 0.2s ease;
        cursor: pointer;
        background: none;
        border: none;
        width: 100%;
        font-family: inherit;
      }

      .privacy-link:hover {
        opacity: 1;
      }

      .privacy-link:focus-visible {
        opacity: 1;
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .data-export-dialog {
        display: none;
        background: rgba(0, 0, 0, 0.5);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .data-export-dialog.visible {
        display: flex;
      }

      .data-export-content {
        background: var(--neutral-surface);
        border-radius: 12px;
        padding: 2rem;
        max-width: 400px;
        width: 100%;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      }

      .data-export-title {
        font-family: 'Cormorant Garamond', Georgia, serif;
        font-size: 1.5rem;
        color: var(--primary);
        margin: 0 0 1rem;
      }

      .data-export-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--neutral-dark);
        margin-bottom: 1.5rem;
      }

      .data-export-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
      }

      .data-export-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        font-family: inherit;
      }

      .data-export-btn.primary {
        background: var(--primary);
        color: var(--neutral-light);
      }

      .data-export-btn.primary:hover:not(:disabled) {
        opacity: 0.9;
      }

      .data-export-btn.secondary {
        background: transparent;
        color: var(--neutral-dark);
        border: 1px solid var(--neutral-border);
      }

      .data-export-btn.secondary:hover {
        border-color: var(--neutral-dark);
      }

      .data-export-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .data-export-btn:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .data-export-status {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .data-export-status.success {
        background: rgba(143, 172, 139, 0.15);
        color: var(--accent);
      }

      .data-export-status.error {
        background: rgba(201, 130, 107, 0.15);
        color: var(--primary);
      }

      .data-export-status.hidden {
        display: none;
      }

      /* Inline error display */
      .submission-error {
        display: none;
        background: rgba(201, 130, 107, 0.1);
        border: 1px solid rgba(201, 130, 107, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .submission-error.visible {
        display: block;
      }

      .submission-error-message {
        font-size: 0.95rem;
        color: var(--primary);
        margin: 0 0 0.75rem;
        line-height: 1.5;
      }

      .submission-error-hint {
        font-size: 0.85rem;
        color: var(--neutral-dark);
        opacity: 0.7;
        margin: 0 0 1rem;
      }

      .retry-btn {
        display: inline-block;
        padding: 0.625rem 1.5rem;
        background: transparent;
        color: var(--primary);
        border: 1px solid var(--primary);
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .retry-btn:hover {
        background: var(--primary);
        color: var(--neutral-light);
      }

      .retry-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .retry-btn:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .back-link:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .dietary-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(201, 130, 107, 0.2);
      }

      /* Photo opt-out checkbox section */
      .photo-optout-section {
        margin-bottom: 2rem;
        padding: 1rem;
        background: rgba(143, 172, 139, 0.08);
        border-radius: 8px;
      }

      .photo-optout-label {
        display: flex;
        align-items: flex-start;
        cursor: pointer;
        position: relative;
        padding-left: 32px;
      }

      .photo-optout-checkbox {
        position: absolute;
        opacity: 0;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }

      .photo-optout-checkmark {
        position: absolute;
        left: 0;
        top: 2px;
        width: 20px;
        height: 20px;
        border: 2px solid var(--neutral-border);
        border-radius: 4px;
        background: var(--neutral-surface);
        transition: all 0.2s ease;
      }

      .photo-optout-checkbox:checked + .photo-optout-checkmark {
        background: var(--accent);
        border-color: var(--accent);
      }

      .photo-optout-checkbox:checked + .photo-optout-checkmark::after {
        content: '';
        position: absolute;
        left: 6px;
        top: 2px;
        width: 5px;
        height: 10px;
        border: solid var(--neutral-light);
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }

      .photo-optout-checkbox:focus-visible + .photo-optout-checkmark {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .photo-optout-text {
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--neutral-dark);
        line-height: 1.4;
      }

      .photo-optout-hint {
        font-size: 0.8rem;
        color: var(--neutral-dark);
        opacity: 0.6;
        margin: 0.5rem 0 0 32px;
        line-height: 1.4;
      }

      /* Visually hidden but accessible to screen readers */
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* Reset fieldset styles */
      fieldset.rsvp-options {
        border: none;
        padding: 0;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="rsvp-container">
      {errorMessage ? (
        <div class="error-container">
          <div class="error-icon" aria-hidden="true">
            {error === 'FEATURE_DISABLED' ? '‚è∏' : 'üíå'}
          </div>
          <p class="error-message">{errorMessage}</p>
        </div>
      ) : data && guest && wedding && (
        <>
          <h1 class="couple-names">{wedding.partnerNames[0]} & {wedding.partnerNames[1]}</h1>
          <p class="event-label">Wedding Celebration</p>

          <div class="success-container" id="success">
            <div class="success-icon" aria-hidden="true">üéâ</div>
            <h2 class="success-title">Thank you!</h2>
            <p class="success-message" id="success-message"></p>
            <a href={`/w/${wedding.slug}`} class="back-link">View wedding details</a>
          </div>

          <div class="form-container" id="form">
            <p class="greeting">
              Hello <strong>{guest.name}</strong>,<br />
              will you be joining us?
            </p>

            {guest.rsvpStatus !== 'pending' && (
              <div class="current-status">
                You previously responded: <strong>
                  {guest.rsvpStatus === 'attending' ? 'Attending' : 'Not attending'}
                </strong>
              </div>
            )}

            <div class="submission-error" id="submission-error" role="alert" aria-live="assertive">
              <p class="submission-error-message" id="submission-error-message">
                We couldn't send your response. Please check your connection and try again.
              </p>
              <p class="submission-error-hint" id="submission-error-hint">
                Your selections have been saved. Click retry when you're ready.
              </p>
              <button type="button" class="retry-btn" id="retry-btn">Try again</button>
            </div>

            <form id="rsvp-form" aria-label="RSVP form">
              <input type="hidden" name="token" value={token} />

              <fieldset class="rsvp-options" role="radiogroup" aria-label="Will you be attending?">
                <legend class="visually-hidden">Will you be attending?</legend>
                <label class="rsvp-option" data-value="attending">
                  <input type="radio" name="rsvpStatus" value="attending" checked={guest.rsvpStatus === 'attending'} aria-describedby="rsvp-help" />
                  <span class="rsvp-option-radio" aria-hidden="true"></span>
                  <span>Joyfully accept</span>
                </label>
                <label class="rsvp-option" data-value="not_attending">
                  <input type="radio" name="rsvpStatus" value="not_attending" checked={guest.rsvpStatus === 'not_attending'} aria-describedby="rsvp-help" />
                  <span class="rsvp-option-radio" aria-hidden="true"></span>
                  <span>Regretfully decline</span>
                </label>
              </fieldset>
              <p id="rsvp-help" class="visually-hidden">Select your attendance response</p>

              <div class="party-size-section" id="party-size-section">
                <span class="section-label">Number of guests in your party</span>
                <div class="stepper">
                  <button type="button" class="stepper-btn" id="decrease-btn" aria-label="Decrease party size">‚àí</button>
                  <span class="stepper-value" id="party-size-value">{guest.partySize}</span>
                  <input type="hidden" name="partySize" id="party-size-input" value={guest.partySize} />
                  <button type="button" class="stepper-btn" id="increase-btn" aria-label="Increase party size">+</button>
                </div>
              </div>

              {/* Plus-one section - only shown if guest has plus-one allowance */}
              <div class="plus-one-section" id="plus-one-section" data-allowance={guest.plusOneAllowance || 0}>
                <span class="section-label">Who will be joining you?</span>
                <p class="plus-one-intro">
                  Please provide the names of your additional guests so we can prepare their place cards.
                </p>
                <div class="plus-one-cards" id="plus-one-cards">
                  {/* Plus-one cards will be dynamically added here */}
                  {(guest.plusOneGuests || []).map((plusOne, index) => (
                    <div class="plus-one-card" data-index={index}>
                      <div class="plus-one-card-header">
                        <span class="plus-one-card-label">Guest {index + 1}</span>
                        <button type="button" class="plus-one-remove-btn" aria-label="Remove guest">√ó</button>
                      </div>
                      <input
                        type="text"
                        class="plus-one-input plus-one-name"
                        placeholder="Full name"
                        value={plusOne.name}
                        required
                      />
                      <input
                        type="text"
                        class="plus-one-input plus-one-dietary"
                        placeholder="Dietary restrictions (optional)"
                        value={plusOne.dietaryNotes || ''}
                      />
                    </div>
                  ))}
                </div>
                <button type="button" class="add-plus-one-btn" id="add-plus-one-btn">
                  + Add a guest
                </button>
                <p class="plus-one-limit-hint" id="plus-one-limit-hint">
                  You can bring up to {guest.plusOneAllowance || 0} additional guest{(guest.plusOneAllowance || 0) !== 1 ? 's' : ''}
                </p>
              </div>

              <div class="dietary-section" id="dietary-section">
                <label class="section-label" for="dietary-notes">Any dietary restrictions? (optional)</label>
                <textarea
                  class="dietary-input"
                  name="dietaryNotes"
                  id="dietary-notes"
                  placeholder="Let us know about any allergies or dietary needs..."
                >{guest.dietaryNotes || ''}</textarea>
              </div>

              <div class="photo-optout-section" id="photo-optout-section">
                <label class="photo-optout-label">
                  <input
                    type="checkbox"
                    name="photoOptOut"
                    id="photo-optout"
                    checked={guest.photoOptOut}
                    class="photo-optout-checkbox"
                  />
                  <span class="photo-optout-checkmark" aria-hidden="true"></span>
                  <span class="photo-optout-text">Please don't include me in event photos</span>
                </label>
                <p class="photo-optout-hint">Let us know if you'd prefer not to appear in shared photos from the event.</p>
              </div>

              <button type="submit" class="submit-btn" id="submit-btn">
                Send response
              </button>
            </form>

            <div class="privacy-section">
              <button type="button" class="privacy-link" id="request-data-btn">
                Request a copy of your data
              </button>
            </div>
          </div>

          <!-- Data Export Dialog -->
          <div class="data-export-dialog" id="data-export-dialog" role="dialog" aria-labelledby="data-export-title" aria-modal="true">
            <div class="data-export-content">
              <h2 class="data-export-title" id="data-export-title">Request Your Data</h2>
              <p class="data-export-text">
                We'll send a copy of all the information we have about you to your email address.
              </p>
              <div class="data-export-actions" id="data-export-actions">
                <button type="button" class="data-export-btn secondary" id="data-export-cancel">Cancel</button>
                <button type="button" class="data-export-btn primary" id="data-export-confirm">Send to my email</button>
              </div>
              <div class="data-export-status hidden" id="data-export-status"></div>
            </div>
          </div>
        </>
      )}
    </div>

    {!errorMessage && data && (
      <script define:vars={{ apiBaseUrl: import.meta.env.PUBLIC_PLATFORM_API_URL || 'http://localhost:3001/api' }}>
        document.addEventListener('DOMContentLoaded', () => {
          const form = document.getElementById('rsvp-form');
          const formContainer = document.getElementById('form');
          const successContainer = document.getElementById('success');
          const successMessage = document.getElementById('success-message');
          const submitBtn = document.getElementById('submit-btn');
          const options = document.querySelectorAll('.rsvp-option');
          const partySizeSection = document.getElementById('party-size-section');
          const dietarySection = document.getElementById('dietary-section');
          const partySizeValue = document.getElementById('party-size-value');
          const partySizeInput = document.getElementById('party-size-input');
          const decreaseBtn = document.getElementById('decrease-btn');
          const increaseBtn = document.getElementById('increase-btn');

          // Plus-one elements
          const plusOneSection = document.getElementById('plus-one-section');
          const plusOneCards = document.getElementById('plus-one-cards');
          const addPlusOneBtn = document.getElementById('add-plus-one-btn');
          const plusOneLimitHint = document.getElementById('plus-one-limit-hint');
          const plusOneAllowance = parseInt(plusOneSection?.dataset.allowance) || 0;

          // Error display elements
          const submissionError = document.getElementById('submission-error');
          const submissionErrorMessage = document.getElementById('submission-error-message');
          const submissionErrorHint = document.getElementById('submission-error-hint');
          const retryBtn = document.getElementById('retry-btn');

          // Error type tracking
          let lastErrorType = null; // 'network' or 'api'

          // Get current plus-one count
          function getPlusOneCount() {
            return plusOneCards?.querySelectorAll('.plus-one-card').length || 0;
          }

          // Update plus-one UI state
          function updatePlusOneUI() {
            const count = getPlusOneCount();
            const canAddMore = count < plusOneAllowance;

            if (addPlusOneBtn) {
              addPlusOneBtn.disabled = !canAddMore;
              addPlusOneBtn.textContent = canAddMore ? '+ Add a guest' : 'Maximum guests added';
            }

            if (plusOneLimitHint) {
              const remaining = plusOneAllowance - count;
              if (count === 0) {
                plusOneLimitHint.textContent = `You can bring up to ${plusOneAllowance} additional guest${plusOneAllowance !== 1 ? 's' : ''}`;
              } else if (remaining > 0) {
                plusOneLimitHint.textContent = `${remaining} more guest${remaining !== 1 ? 's' : ''} available`;
              } else {
                plusOneLimitHint.textContent = 'All guest spots filled';
              }
            }

            // Update party size to reflect plus-ones + 1 (the guest)
            updatePartySizeFromPlusOnes();

            // Re-number card labels
            const cards = plusOneCards?.querySelectorAll('.plus-one-card') || [];
            cards.forEach((card, index) => {
              const label = card.querySelector('.plus-one-card-label');
              if (label) {
                label.textContent = `Guest ${index + 1}`;
              }
            });
          }

          // Update party size based on plus-one count
          function updatePartySizeFromPlusOnes() {
            const plusOneCount = getPlusOneCount();
            const minPartySize = 1 + plusOneCount; // Guest + plus-ones

            if (partySize < minPartySize) {
              partySize = minPartySize;
              updatePartySize();
            }

            // Update minimum for stepper
            if (decreaseBtn) {
              decreaseBtn.disabled = partySize <= minPartySize;
            }
          }

          // Create a plus-one card element
          function createPlusOneCard(index, name = '', dietary = '') {
            const card = document.createElement('div');
            card.className = 'plus-one-card';
            card.dataset.index = index;
            card.innerHTML = `
              <div class="plus-one-card-header">
                <span class="plus-one-card-label">Guest ${index + 1}</span>
                <button type="button" class="plus-one-remove-btn" aria-label="Remove guest">√ó</button>
              </div>
              <input
                type="text"
                class="plus-one-input plus-one-name"
                placeholder="Full name"
                value="${name}"
                required
              />
              <input
                type="text"
                class="plus-one-input plus-one-dietary"
                placeholder="Dietary restrictions (optional)"
                value="${dietary}"
              />
            `;

            // Add remove handler
            const removeBtn = card.querySelector('.plus-one-remove-btn');
            removeBtn.addEventListener('click', () => {
              card.remove();
              updatePlusOneUI();
            });

            return card;
          }

          // Add plus-one button handler
          if (addPlusOneBtn && plusOneAllowance > 0) {
            addPlusOneBtn.addEventListener('click', () => {
              const count = getPlusOneCount();
              if (count < plusOneAllowance) {
                const card = createPlusOneCard(count);
                plusOneCards.appendChild(card);
                updatePlusOneUI();
                // Focus the name input
                card.querySelector('.plus-one-name')?.focus();
              }
            });
          }

          // Initialize remove button handlers for existing cards
          plusOneCards?.querySelectorAll('.plus-one-remove-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.target.closest('.plus-one-card')?.remove();
              updatePlusOneUI();
            });
          });

          // Get plus-one guests data
          function getPlusOneGuests() {
            const cards = plusOneCards?.querySelectorAll('.plus-one-card') || [];
            const guests = [];
            cards.forEach(card => {
              const name = card.querySelector('.plus-one-name')?.value?.trim();
              const dietary = card.querySelector('.plus-one-dietary')?.value?.trim();
              if (name) {
                guests.push({
                  name,
                  dietaryNotes: dietary || undefined,
                });
              }
            });
            return guests;
          }

          // Update UI based on current selection
          function updateUI() {
            const selected = document.querySelector('input[name="rsvpStatus"]:checked');
            const isAttending = selected && selected.value === 'attending';

            options.forEach(opt => {
              const input = opt.querySelector('input');
              opt.classList.toggle('selected', input.checked);
            });

            partySizeSection.classList.toggle('visible', isAttending);
            dietarySection.classList.toggle('visible', isAttending);

            // Show plus-one section if attending and has allowance
            if (plusOneSection && plusOneAllowance > 0) {
              plusOneSection.classList.toggle('visible', isAttending);
            }
          }

          // Initialize UI
          updateUI();
          updatePlusOneUI();

          // Handle option selection
          options.forEach(option => {
            option.addEventListener('click', () => {
              const input = option.querySelector('input');
              input.checked = true;
              updateUI();
            });
          });

          // Party size stepper
          let partySize = parseInt(partySizeInput.value) || 1;

          function updatePartySize() {
            partySizeValue.textContent = partySize;
            partySizeInput.value = partySize;

            const minPartySize = 1 + getPlusOneCount();
            decreaseBtn.disabled = partySize <= minPartySize;
            increaseBtn.disabled = partySize >= 20;
          }

          decreaseBtn.addEventListener('click', () => {
            const minPartySize = 1 + getPlusOneCount();
            if (partySize > minPartySize) {
              partySize--;
              updatePartySize();
            }
          });

          increaseBtn.addEventListener('click', () => {
            if (partySize < 20) {
              partySize++;
              updatePartySize();
            }
          });

          updatePartySize();

          // Show inline error with appropriate message
          function showError(type, message) {
            lastErrorType = type;

            if (type === 'network') {
              submissionErrorMessage.textContent = "We couldn't send your response. Please check your connection and try again.";
              submissionErrorHint.textContent = "Your selections have been saved. Click retry when you're ready.";
            } else if (type === 'plus_one_limit') {
              submissionErrorMessage.textContent = message || "You've exceeded the number of allowed additional guests.";
              submissionErrorHint.textContent = "Please remove some guests and try again.";
            } else {
              // API error (server returned an error)
              submissionErrorMessage.textContent = "Something went wrong while saving your response.";
              submissionErrorHint.textContent = "Please try again in a moment.";
            }

            submissionError.classList.add('visible');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send response';
          }

          // Hide error display
          function hideError() {
            submissionError.classList.remove('visible');
            lastErrorType = null;
          }

          // Submit RSVP data
          async function submitRsvp() {
            hideError();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            retryBtn.disabled = true;

            const formData = new FormData(form);
            const plusOneGuests = getPlusOneGuests();

            // Validate plus-one limit client-side
            if (plusOneGuests.length > plusOneAllowance) {
              showError('plus_one_limit', `You can only bring up to ${plusOneAllowance} additional guest${plusOneAllowance !== 1 ? 's' : ''}.`);
              retryBtn.disabled = false;
              return;
            }

            const photoOptOutCheckbox = document.getElementById('photo-optout');
            const photoOptOut = photoOptOutCheckbox?.checked || false;

            const data = {
              token: formData.get('token'),
              rsvpStatus: formData.get('rsvpStatus'),
              partySize: parseInt(formData.get('partySize')) || 1,
              dietaryNotes: formData.get('dietaryNotes') || undefined,
              plusOneGuests: plusOneGuests.length > 0 ? plusOneGuests : undefined,
              photoOptOut,
            };

            try {
              const response = await fetch(`${apiBaseUrl}/rsvp/submit`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
              });

              const result = await response.json();

              if (result.ok) {
                formContainer.classList.add('hidden');
                successContainer.classList.add('visible');
                successMessage.textContent = result.data.message;
              } else {
                // Check for specific error codes
                if (result.error === 'PLUS_ONE_LIMIT_EXCEEDED') {
                  showError('plus_one_limit');
                } else {
                  showError('api');
                }
              }
            } catch (error) {
              // Network error (fetch failed, timeout, no connection, etc.)
              console.error('Error submitting RSVP:', error);
              showError('network');
            } finally {
              retryBtn.disabled = false;
            }
          }

          // Form submission
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await submitRsvp();
          });

          // Retry button click
          retryBtn.addEventListener('click', async () => {
            await submitRsvp();
          });

          // Data export dialog handling
          const requestDataBtn = document.getElementById('request-data-btn');
          const dataExportDialog = document.getElementById('data-export-dialog');
          const dataExportCancel = document.getElementById('data-export-cancel');
          const dataExportConfirm = document.getElementById('data-export-confirm');
          const dataExportStatus = document.getElementById('data-export-status');
          const dataExportActions = document.getElementById('data-export-actions');

          // Get the token from the form
          const tokenInput = document.querySelector('input[name="token"]');
          const guestToken = tokenInput?.value;

          // Open dialog
          requestDataBtn?.addEventListener('click', () => {
            dataExportDialog.classList.add('visible');
            dataExportStatus.classList.add('hidden');
            dataExportActions.style.display = 'flex';
            dataExportConfirm.disabled = false;
            dataExportCancel.disabled = false;
          });

          // Close dialog
          dataExportCancel?.addEventListener('click', () => {
            dataExportDialog.classList.remove('visible');
          });

          // Close dialog on backdrop click
          dataExportDialog?.addEventListener('click', (e) => {
            if (e.target === dataExportDialog) {
              dataExportDialog.classList.remove('visible');
            }
          });

          // Handle data export request
          dataExportConfirm?.addEventListener('click', async () => {
            if (!guestToken) {
              dataExportStatus.textContent = 'Unable to process request. Please refresh the page.';
              dataExportStatus.className = 'data-export-status error';
              return;
            }

            dataExportConfirm.disabled = true;
            dataExportCancel.disabled = true;
            dataExportConfirm.textContent = 'Sending...';

            try {
              const response = await fetch(`${apiBaseUrl}/rsvp/data-export`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: guestToken }),
              });

              const result = await response.json();

              if (result.ok) {
                dataExportActions.style.display = 'none';
                dataExportStatus.textContent = `${result.data.message} (${result.data.sentTo})`;
                dataExportStatus.className = 'data-export-status success';
              } else {
                dataExportStatus.textContent = 'Unable to send data export. Please try again later.';
                dataExportStatus.className = 'data-export-status error';
                dataExportConfirm.textContent = 'Send to my email';
                dataExportConfirm.disabled = false;
                dataExportCancel.disabled = false;
              }
            } catch (error) {
              console.error('Error requesting data export:', error);
              dataExportStatus.textContent = 'Network error. Please check your connection and try again.';
              dataExportStatus.className = 'data-export-status error';
              dataExportConfirm.textContent = 'Send to my email';
              dataExportConfirm.disabled = false;
              dataExportCancel.disabled = false;
            }
          });

          // Close dialog on Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && dataExportDialog.classList.contains('visible')) {
              dataExportDialog.classList.remove('visible');
            }
          });
        });
      </script>
    )}
  </body>
</html>
