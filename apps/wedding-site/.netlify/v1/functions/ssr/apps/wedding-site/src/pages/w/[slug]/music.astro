---
/**
 * Music request page.
 * Allows guests to suggest songs for the wedding playlist.
 * PRD: "Guest can suggest songs"
 */
import type { RenderConfig } from '../../../types';
import { fetchSiteConfig } from '../../../lib/api';
import WeddingLayout from '../../../components/WeddingLayout.astro';
import PasscodeGateWrapper from '../../../components/PasscodeGateWrapper.astro';
import ErrorPage from '../../../components/ErrorPage.astro';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Fetch render_config with error handling
let config: RenderConfig | null = null;
let fetchError = false;

try {
  config = await fetchSiteConfig(slug);
} catch {
  fetchError = true;
}

// Determine error state for template rendering
const showError = !config || fetchError;
const errorType: 'unavailable' | 'not-found' = fetchError ? 'unavailable' : 'not-found';

const musicEnabled = config?.features?.MUSIC_REQUESTS ?? false;
const weddingTitle = config ? `${config.wedding.partnerNames[0]} & ${config.wedding.partnerNames[1]}` : '';
const weddingSlug = config?.wedding.slug ?? '';
const theme = config?.theme ?? { primary: '#c9826b', accent: '#8fac8b', neutralLight: '#faf8f5', neutralDark: '#2d2d2d' };
const apiBaseUrl = import.meta.env.PUBLIC_PLATFORM_API_URL || 'http://localhost:3001/api';
---

{showError && <ErrorPage type={errorType} />}

{!showError && config && (
  <PasscodeGateWrapper config={config}>
    <WeddingLayout config={config}>
      <section
        class="music-page"
        style={`--primary: ${theme.primary}; --accent: ${theme.accent}; --neutral-light: ${theme.neutralLight}; --neutral-dark: ${theme.neutralDark};`}
      >
        <div class="music-page-content">
          <a href={`/w/${weddingSlug}`} class="back-link">Back to the wedding site</a>
          <h1 class="music-title">Suggest a Song</h1>
          <p class="music-description">
            Help us create the perfect playlist for our celebration! Share your favorite songs and we'll consider them for our big day.
          </p>

          {musicEnabled ? (
            <div class="music-card" id="music-form-container">
              <form id="music-form" class="music-form">
                <div class="form-group">
                  <label for="songTitle">Song Title</label>
                  <input
                    type="text"
                    id="songTitle"
                    name="songTitle"
                    required
                    placeholder="Enter the song name"
                    maxlength="200"
                  />
                </div>

                <div class="form-group">
                  <label for="artistName">Artist</label>
                  <input
                    type="text"
                    id="artistName"
                    name="artistName"
                    required
                    placeholder="Enter the artist name"
                    maxlength="200"
                  />
                </div>

                <div class="form-group">
                  <label for="requesterName">Your Name <span class="optional">(optional)</span></label>
                  <input
                    type="text"
                    id="requesterName"
                    name="requesterName"
                    placeholder="Let us know who suggested this"
                    maxlength="100"
                  />
                </div>

                <button type="submit" class="submit-button" id="submit-button">
                  <span id="button-text">Submit Song Request</span>
                  <span id="button-loading" class="hidden">Submitting...</span>
                </button>

                <div id="error-message" class="error-message hidden"></div>
              </form>

              <div id="success-message" class="success-message hidden">
                <div class="success-icon">â™ª</div>
                <h2>Thank you!</h2>
                <p>Your song request has been submitted. We appreciate your suggestion!</p>
                <button type="button" class="suggest-another-button" id="suggest-another">
                  Suggest Another Song
                </button>
              </div>
            </div>
          ) : (
            <div class="music-disabled">
              Song requests are currently not available for this wedding.
            </div>
          )}
        </div>
      </section>
    </WeddingLayout>
  </PasscodeGateWrapper>
)}

{!showError && musicEnabled && (
  <script
    is:inline
    define:vars={{ apiBaseUrl, weddingSlug }}
  >
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('music-form');
      const submitButton = document.getElementById('submit-button');
      const buttonText = document.getElementById('button-text');
      const buttonLoading = document.getElementById('button-loading');
      const errorMessage = document.getElementById('error-message');
      const successMessage = document.getElementById('success-message');
      const suggestAnother = document.getElementById('suggest-another');

      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          // Hide previous error
          if (errorMessage) {
            errorMessage.classList.add('hidden');
          }

          // Get form data
          const songTitle = document.getElementById('songTitle').value.trim();
          const artistName = document.getElementById('artistName').value.trim();
          const requesterName = document.getElementById('requesterName').value.trim();

          // Validate
          if (!songTitle || !artistName) {
            if (errorMessage) {
              errorMessage.textContent = 'Please fill in the song title and artist name.';
              errorMessage.classList.remove('hidden');
            }
            return;
          }

          // Show loading state
          if (submitButton) submitButton.disabled = true;
          if (buttonText) buttonText.classList.add('hidden');
          if (buttonLoading) buttonLoading.classList.remove('hidden');

          try {
            const response = await fetch(`${apiBaseUrl}/music/${weddingSlug}/request`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                songTitle,
                artistName,
                requesterName: requesterName || undefined,
              }),
            });

            const data = await response.json();

            if (data.ok) {
              // Show success message
              if (form) form.classList.add('hidden');
              if (successMessage) successMessage.classList.remove('hidden');
            } else {
              throw new Error(data.error || 'Failed to submit song request');
            }
          } catch (err) {
            if (errorMessage) {
              errorMessage.textContent = 'Something went wrong. Please try again.';
              errorMessage.classList.remove('hidden');
            }
          } finally {
            // Reset loading state
            if (submitButton) submitButton.disabled = false;
            if (buttonText) buttonText.classList.remove('hidden');
            if (buttonLoading) buttonLoading.classList.add('hidden');
          }
        });
      }

      // Handle "Suggest Another" button
      if (suggestAnother) {
        suggestAnother.addEventListener('click', () => {
          // Reset form
          if (form) {
            form.reset();
            form.classList.remove('hidden');
          }
          if (successMessage) successMessage.classList.add('hidden');
          if (errorMessage) errorMessage.classList.add('hidden');
        });
      }
    });
  </script>
)}

<style>
  .music-page {
    background-color: var(--neutral-light);
    padding: 6rem 2rem 5rem;
  }

  .music-page-content {
    max-width: 520px;
    margin: 0 auto;
    text-align: center;
  }

  .back-link {
    display: inline-block;
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 0.95rem;
    color: var(--primary);
    text-decoration: none;
    margin-bottom: 2.5rem;
  }

  .back-link:hover {
    opacity: 0.8;
  }

  .music-title {
    font-family: 'Cormorant Garamond', 'Georgia', serif;
    font-size: clamp(2rem, 6vw, 3.25rem);
    font-weight: 400;
    color: var(--neutral-dark);
    margin: 0 0 1.5rem 0;
    letter-spacing: 0.02em;
  }

  .music-description {
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 1.1rem;
    line-height: 1.7;
    color: var(--neutral-dark);
    opacity: 0.78;
    margin: 0 0 3rem 0;
  }

  .music-card {
    padding: 2.5rem;
    border-radius: 16px;
    background-color: var(--neutral-light);
    box-shadow: 0 20px 50px rgba(45, 45, 45, 0.08);
    text-align: left;
  }

  .music-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--neutral-dark);
  }

  .optional {
    font-weight: 400;
    opacity: 0.6;
  }

  .form-group input {
    padding: 0.875rem 1rem;
    border: 1px solid rgba(45, 45, 45, 0.15);
    border-radius: 10px;
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 1rem;
    background-color: rgba(255, 255, 255, 0.5);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(201, 130, 107, 0.15);
  }

  .form-group input::placeholder {
    color: var(--neutral-dark);
    opacity: 0.4;
  }

  .submit-button {
    margin-top: 0.5rem;
    padding: 1rem 2rem;
    background-color: var(--primary);
    color: var(--neutral-light);
    border: none;
    border-radius: 999px;
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .submit-button:hover:not(:disabled) {
    opacity: 0.9;
  }

  .submit-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .error-message {
    margin-top: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(201, 130, 107, 0.1);
    border: 1px solid rgba(201, 130, 107, 0.3);
    border-radius: 10px;
    color: var(--primary);
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 0.9rem;
    text-align: center;
  }

  .success-message {
    text-align: center;
    padding: 2rem 0;
  }

  .success-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--accent);
  }

  .success-message h2 {
    font-family: 'Cormorant Garamond', 'Georgia', serif;
    font-size: 1.75rem;
    font-weight: 400;
    color: var(--neutral-dark);
    margin: 0 0 0.5rem 0;
  }

  .success-message p {
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 1rem;
    color: var(--neutral-dark);
    opacity: 0.75;
    margin: 0 0 1.5rem 0;
  }

  .suggest-another-button {
    padding: 0.75rem 1.5rem;
    background: transparent;
    color: var(--primary);
    border: 2px solid var(--primary);
    border-radius: 999px;
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .suggest-another-button:hover {
    background: var(--primary);
    color: var(--neutral-light);
  }

  .music-disabled {
    font-family: 'Inter', 'Helvetica Neue', sans-serif;
    font-size: 1rem;
    color: var(--neutral-dark);
    opacity: 0.75;
    padding: 2rem;
    border-radius: 16px;
    background-color: var(--neutral-light);
    box-shadow: 0 20px 50px rgba(45, 45, 45, 0.08);
  }

  .hidden {
    display: none !important;
  }

  @media (max-width: 640px) {
    .music-card {
      padding: 2rem 1.5rem;
    }
  }
</style>
