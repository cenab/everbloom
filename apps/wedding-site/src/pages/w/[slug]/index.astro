---
/**
 * Wedding site dynamic route
 * Renders exclusively from render_config - no direct database joins
 */
import type { RenderConfig } from '../../../types';
import { fetchSiteConfig } from '../../../lib/api';
import WeddingLayout from '../../../components/WeddingLayout.astro';
import AnnouncementBanner from '../../../components/AnnouncementBanner.astro';
import SectionRenderer from '../../../components/SectionRenderer.astro';
import PasscodeGateWrapper from '../../../components/PasscodeGateWrapper.astro';
import ErrorPage from '../../../components/ErrorPage.astro';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Fetch render_config - this is the ONLY data fetch for rendering
let config: RenderConfig | null = null;
let fetchError = false;

try {
  config = await fetchSiteConfig(slug);
} catch (error) {
  // Network or API error
  fetchError = true;
}

// Determine error state for template rendering
const showError = !config || fetchError;
const errorType: 'unavailable' | 'not-found' = fetchError ? 'unavailable' : 'not-found';

// Prepare data for rendering - only computed when config exists
const announcement = config?.announcement ?? { enabled: false, title: '', message: '' };
const showAnnouncement = config &&
  config.features.ANNOUNCEMENT_BANNER &&
  announcement.enabled &&
  Boolean(announcement.title.trim() || announcement.message.trim());
---

{showError && <ErrorPage type={errorType} />}

{!showError && config && (
  <PasscodeGateWrapper config={config}>
    <WeddingLayout config={config}>
      {showAnnouncement && <AnnouncementBanner announcement={announcement} theme={config.theme} />}
      <SectionRenderer config={config} />
    </WeddingLayout>
  </PasscodeGateWrapper>
)}
