---
/**
 * Wedding site dynamic route
 * Renders exclusively from render_config - no direct database joins
 * PRD: "Site supports multiple languages" + "Guest can set language preference"
 */
import type { RenderConfig } from '../../../types';
import { fetchSiteConfig } from '../../../lib/api';
import WeddingLayout from '../../../components/WeddingLayout.astro';
import AnnouncementBanner from '../../../components/AnnouncementBanner.astro';
import SectionRenderer from '../../../components/SectionRenderer.astro';
import PasscodeGateWrapper from '../../../components/PasscodeGateWrapper.astro';
import ErrorPage from '../../../components/ErrorPage.astro';
import LanguageSelector from '../../../components/LanguageSelector.astro';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Fetch render_config - this is the ONLY data fetch for rendering
let config: RenderConfig | null = null;
let fetchError = false;

try {
  config = await fetchSiteConfig(slug);
} catch (error) {
  // Network or API error
  fetchError = true;
}

// Determine error state for template rendering
const showError = !config || fetchError;
const errorType: 'unavailable' | 'not-found' = fetchError ? 'unavailable' : 'not-found';

// Language selection priority:
// 1. URL query param (?lang=es) - allows sharing links in specific language
// 2. Admin-set site language (from render_config.language)
// Guest localStorage preference is read client-side and redirects with ?lang param
const urlLang = Astro.url.searchParams.get('lang');
const adminLanguage = config?.language || 'en';
const effectiveLanguage = urlLang || adminLanguage;

// Prepare data for rendering - only computed when config exists
const announcement = config?.announcement ?? { enabled: false, title: '', message: '' };
const showAnnouncement = config &&
  config.features.ANNOUNCEMENT_BANNER &&
  announcement.enabled &&
  Boolean(announcement.title.trim() || announcement.message.trim());
---

{showError && <ErrorPage type={errorType} />}

{!showError && config && (
  <PasscodeGateWrapper config={config}>
    <WeddingLayout config={config} language={effectiveLanguage}>
      <div class="language-selector-container">
        <LanguageSelector currentLanguage={effectiveLanguage} slug={slug} />
      </div>
      {showAnnouncement && <AnnouncementBanner announcement={announcement} theme={config.theme} />}
      <SectionRenderer config={{...config, language: effectiveLanguage}} />
    </WeddingLayout>
  </PasscodeGateWrapper>
)}

<style>
  .language-selector-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 50;
  }

  @media (max-width: 640px) {
    .language-selector-container {
      top: 0.75rem;
      right: 0.75rem;
    }
  }
</style>

<script define:vars={{ slug }}>
  /**
   * Check for stored language preference on page load
   * If guest has a preference different from current URL, redirect
   */
  (function() {
    try {
      const storedLang = localStorage.getItem(`everbloom_language_${slug}`);
      const urlParams = new URLSearchParams(window.location.search);
      const urlLang = urlParams.get('lang');

      // If there's a stored preference and it's not already in the URL, redirect
      if (storedLang && storedLang !== urlLang) {
        urlParams.set('lang', storedLang);
        const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
        // Use replace to avoid adding to history
        window.location.replace(newUrl);
      }
    } catch {
      // localStorage might not be available
    }
  })();
</script>
