---
/**
 * Wedding site dynamic route
 * Renders exclusively from render_config - no direct database joins
 */
import { fetchSiteConfig } from '../../lib/api';
import WeddingLayout from '../../components/WeddingLayout.astro';
import AnnouncementBanner from '../../components/AnnouncementBanner.astro';
import SectionRenderer from '../../components/SectionRenderer.astro';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Fetch render_config - this is the ONLY data fetch for rendering
const config = await fetchSiteConfig(slug);

if (!config) {
  // Wedding not found - return 404
  return new Response('Wedding not found', { status: 404 });
}

const announcement = config.announcement ?? { enabled: false, title: '', message: '' };
const showAnnouncement =
  config.features.ANNOUNCEMENT_BANNER &&
  announcement.enabled &&
  Boolean(announcement.title.trim() || announcement.message.trim());
---

<WeddingLayout config={config}>
  {showAnnouncement && <AnnouncementBanner announcement={announcement} theme={config.theme} />}
  <SectionRenderer config={config} />
</WeddingLayout>
