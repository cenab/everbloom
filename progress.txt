## Progress Log

### 2026-01-06 - Initial Monorepo Setup and Dashboard Empty State

**Feature worked on:** Admin dashboard loads with no wedding selected (PRD: platform category)

**Priority rationale:** This is the foundational feature - without the monorepo structure and platform-ui, nothing else can be built. The dashboard empty state is the first user-facing feature after infrastructure.

**What was done:**
1. Created monorepo infrastructure:
   - root package.json with workspace scripts
   - pnpm-workspace.yaml
   - root tsconfig.json with project references
   - .gitignore

2. Created packages/shared with:
   - Core types: FeatureFlag, TemplateCategory, Theme, RenderConfig
   - API response types
   - Error codes (FEATURE_DISABLED, INVALID_TOKEN)

3. Created apps/platform-ui with:
   - Vite + React setup
   - TanStack Router and Query integration
   - Tailwind CSS with design system tokens (no pure black/white, curated palette)
   - Dashboard component with empty state
   - Layout component with minimal navigation

4. Created services/platform-api with:
   - NestJS scaffold
   - Health endpoint
   - CORS configured for dev

5. Created services/worker and apps/wedding-site stubs

**Design system adherence:**
- Colors use curated warm palette (primary: terracotta, accent: sage)
- No pure #000000 or #FFFFFF
- Typography: serif for headings, sans for body
- Minimal, calm UI with intentional whitespace
- Human language in microcopy ("Welcome to Everbloom", not "No records found")

**Next steps:**
- Run `pnpm install` to install dependencies
- Run `pnpm typecheck` and `pnpm test` to verify
- Implement magic link auth (prerequisite for full dashboard feature)
- Implement Stripe billing flow

**Notes for next person:**
- The dashboard shows an empty state that prompts creation/selection of weddings
- Auth is not yet implemented, so "Log in as admin" step cannot pass yet
- Feature "Admin dashboard loads with no wedding selected" depends on auth feature
- PRD should NOT be marked as passing until auth is in place and verified

---

### 2026-01-06 - Magic Link Authentication

**Feature worked on:** Admin can log in via magic link (PRD: platform category)

**Priority rationale:** This is the highest-priority feature because it unblocks:
1. The dashboard feature (which depends on "Log in as admin" step)
2. All platform features that require authentication
3. Admin-only actions like creating weddings, managing guests, etc.

**What was done:**
1. Fixed NestJS API to use `/api` prefix (was missing, frontend was calling `/api/auth/*` but backend was at `/auth/*`)

2. Added workspace dependency wiring:
   - Added `@wedding-bestie/shared` as dependency to platform-api and platform-ui
   - Built shared package to generate dist/ with types

3. Fixed TypeScript configuration issues:
   - Added `@types/node` and `types: ["node"]` to worker service
   - Excluded astro.config.mjs from wedding-site typecheck

4. Fixed test configuration:
   - Added `--passWithNoTests` to platform-api jest command

**Existing auth implementation (already present, now wired up):**
- Login page (Login.tsx): Email input form, sends POST to `/api/auth/request-link`
- VerifyMagicLink page: Handles `/auth/verify?token=...` callback
- AuthProvider (auth.tsx): Manages session state, stores token in localStorage
- AuthController: `/auth/request-link`, `/auth/verify-link`, `/auth/me`, `/auth/logout`
- AuthService: In-memory token/session storage (dev mode), logs magic link to console
- Routes (__root.tsx): Protected routes redirect to `/login`, login redirects if authenticated

**PRD features now passing:**
- "Admin can log in via magic link" ‚úì
- "Admin dashboard loads with no wedding selected" ‚úì (was blocked by auth, now works)

**Next steps:**
- Implement Stripe billing flow (checkout session creation)
- Implement wedding provisioning on checkout.session.completed webhook
- Generate render_config on wedding creation

**Notes for next person:**
- In dev mode, magic links are logged to console (look for "üîê MAGIC LINK" in platform-api output)
- Sessions are stored in-memory (restart API = logout all users)
- Run `pnpm dev` to start both UI and API together
- To test: enter email on login page, copy magic link from API console, paste in browser

---

### 2026-01-06 - Stripe Checkout Session Creation

**Feature worked on:** Stripe checkout session can be created for a new wedding (PRD: billing category)

**Priority rationale:** This is the next critical feature after auth because:
1. It enables the billing flow - couples can't create weddings without paying
2. It unblocks all downstream features (wedding provisioning, render_config, site rendering)
3. It's the gateway to all wedding-specific functionality

**What was done:**
1. Added Stripe SDK to platform-api:
   - Added `stripe` and `@nestjs/config` dependencies
   - Created BillingModule with controller and service

2. Created billing types in shared package:
   - `PlanTier` (starter | premium)
   - `Plan` interface with id, name, priceId, features
   - `CreateCheckoutSessionRequest` and `CreateCheckoutSessionResponse`
   - `CHECKOUT_SESSION_FAILED` error code

3. Implemented BillingService:
   - `getPlans()` - returns available plans with features
   - `createCheckoutSession()` - creates Stripe checkout session with wedding metadata

4. Implemented BillingController:
   - `GET /api/billing/plans` - public endpoint to get plans
   - `POST /api/billing/checkout-session` - authenticated endpoint to start checkout

5. Created UI flow for wedding creation:
   - CreateWedding component with 2-step form
   - Step 1: Enter wedding name and partner names
   - Step 2: Select plan (Starter or Premium)
   - Redirects to Stripe Checkout on submit

6. Created billing result pages:
   - BillingSuccess: Confirmation page with redirect to dashboard
   - BillingCancel: Friendly cancel page with return option

7. Updated Dashboard to integrate CreateWedding:
   - "Create your wedding site" button now triggers the creation flow
   - Added routes for /billing/success and /billing/cancel

**API Endpoints:**
- `GET /api/billing/plans` - Get available plans (public)
- `POST /api/billing/checkout-session` - Create checkout session (requires auth)
  - Request: `{ planId, weddingName, partnerNames }`
  - Response: `{ checkoutUrl, sessionId }`

**Design system adherence:**
- Step indicator with calm transitions
- Plan cards with clear feature lists
- Human language: "Tell us about your wedding", "Your wedding site is being created"
- No pure black/white colors
- Minimal, focused forms

**PRD features now passing:**
- "Stripe checkout session can be created for a new wedding" ‚úì

**Next steps:**
- Implement Stripe webhook handler for checkout.session.completed
- Provision wedding record on successful payment
- Generate render_config on wedding creation
- Set up Stripe test prices for local development

**Notes for next person:**
- Stripe uses test mode by default (set STRIPE_SECRET_KEY for production)
- Plans use placeholder price IDs (price_starter_test, price_premium_test)
- Set STRIPE_PRICE_STARTER and STRIPE_PRICE_PREMIUM env vars for real prices
- Wedding metadata (name, partners) is stored in checkout session metadata
- The checkout.session.completed webhook will read this metadata to create the wedding
